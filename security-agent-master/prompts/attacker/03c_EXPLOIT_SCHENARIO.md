*This is not for a real exploit, but for bug bounty program. We never exploit the real application. This is just a red team simulation.

# =====================================================
# üî¥  SMART-CONTRACT ATTACK-PATH GENERATOR ‚Äì RAG EDITION
# =====================================================

## üß† Cognitive Protocol  (MUST follow in order)
1. **PLAN** ‚Äì Enumerate every sub-task before acting.
2. **THINK (Chain-of-Thought)** ‚Äì Work *step-by-step* inside the `### SCRATCHPAD` (hidden from final answer).
3. **BRANCH (Tree-of-Thought)** ‚Äì When multiple plausible options arise, fork paths `BRANCH-A / BRANCH-B ‚Ä¶`, explore briefly, then keep the best branch and explain why.
4. **CRITIC** ‚Äì After each major phase, run a self-critique checklist to catch omissions or contradictions.
5. **REFLECT** ‚Äì End every phase with `REFLECTION: <what was learned / next improvement>`.
6. **OUTPUT** ‚Äì Provide only the JSON specified in **‚ÄúFinal Output Format‚Äù** ‚Äì never reveal the SCRATCHPAD.

> **Note:** Everything inside ```scratchpad fences is private reasoning and MUST NOT leak.

---

## üì• Inputs
### 1. CONTRACT_SPEC_JSON
Located in @security-agent/outputs/02_SPEC.json

### 2. REFERENCE_SCENARIOS_JSON  (top-k similar attacks retrieved via RAG)
Located in @security-agent/docs/past_attack_scenarios.jsonl

---

## üéØ Tasks  (execute in order ‚Äì follow the Cognitive Protocol!)

### **Task-0: Plan**
* Outline the entire workflow in SCRATCHPAD ‚ûú `PLAN` section.

### **Task-1: Extract Exploit Primitives**
* For each reference scenario, abstract into `{primitive, prerequisite_state, effect}`.
* **Discard primitives that depend on**
  * External price-oracle manipulation or market moves
  * Private-key / signer / validator compromise
  * Social engineering or multisig deception
  * Admin-only or owner-only privileged calls
* De-duplicate and normalise primitives (use SWC IDs where possible).

### **Task-2: Map Primitives to Target Contract**
* For every remaining primitive:
  * Verify that its `prerequisite_state` is satisfiable **on-chain only** within `CONTRACT_SPEC_JSON`.
  * Keep only feasible primitives; explain discards in SCRATCHPAD.

### **Task-3: Construct Attack Paths**
* Search attack graphs up to **depth 3**, combining feasible primitives.
* Use DFS/BFS; branch when multiple choices (maintain BRANCH-X sections).
* For each candidate path, estimate: `profit_usd`, `gas_used`, `required_capital`.

### **Task-4: Rank & Select**
* Score paths: `score = profit_usd / (gas_used + 1e6)`.
* Keep Top-N (default **N = 5**) paths.

### **Task-5: Defensive Mitigations**
* For every selected path, recommend specific fixes (code or infra).

### **Task-6: Critic Pass**
Run the checklist below; **all boxes must be ticked** ‚Äì otherwise revise before continuing.

| ‚úÖ? | Checkpoint |
|-----|-----------|
| ‚òê | Steps reference real functions / storage keys |
| ‚òê | Preconditions logically satisfiable on-chain |
| ‚òê | Profit estimate > 0 |
| ‚òê | No missing SWC tags |
| ‚òê | No duplicated `path_id`s |
| ‚òê | **Exploit is an app-specific logic flaw** (no external oracle skew, key theft, privileged role hijack, or social engineering) |
| ‚òê | **Required capital is realistically obtainable on-chain** (flash-loan OK; no insider access) |

*Revise any path that fails; delete it if unfixable.*

### **Task-7: Meta-Reflection**
* One-sentence reflection on reasoning quality; include in SCRATCHPAD only.

---

## üóÉÔ∏è  Final Output Format  (return **only** this JSON array)
Output to **@security-agent/outputs/03c_EXPLOIT_SCENARIO.json**:

```json
[
  {
    "path_id": "P-1",
    "steps": [
      "1. <step description>",
      "2. ‚Ä¶"
    ],
    "profit_estimate_usd": 3500000,
    "gas_estimate": 3100000,
    "required_capital": "80 M DAI flash-loan",
    "prerequisites": ["Flash-loan provider", "‚â• 1 eToken"],
    "references": ["Euler Donation Attack", "Cream IronBank Reentrancy"],
    "swc_ids": ["SWC-135"],
    "severity": "Critical",
    "score": 4.7,
    "mitigations": [
      "Add share-price cap in donateToReserves()",
      "Introduce circuit-breaker on abnormal eToken inflation"
    ]
  }
]
````

*Return the raw string `"NO_VIABLE_ATTACK"` if no path yields ‚â• \$10 k profit.*

---

## üìù SCRATCHPAD (PRIVATE ‚Äì DO NOT OUTPUT)

```scratchpad
### PLAN
(Your sub-task list)

### REASONING
(Detailed chain-of-thought; calculations; citations to spec)

### BRANCH-A
(Alternative path exploration)

### BRANCH-B
(Alternative path exploration)

### MERGE-DECISION
(Why one branch chosen)

### CRITIC PASS
(Checkpoint ticks & fixes)

### REFLECTION
(What you learned / will improve)
